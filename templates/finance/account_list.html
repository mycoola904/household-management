{% extends "base.html" %}
{% block title %}Accounts Â· Household{% endblock %}
{% block content %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-semibold">Accounts</h1>
        <p class="text-base-content/70">Manage household financial accounts.</p>
    </div>
    <button class="btn btn-primary" hx-get="{% url 'finance:account-create' %}" hx-target="#modal-body" hx-swap="innerHTML">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
            <path fill-rule="evenodd" d="M12 4.5a.75.75 0 01.75.75v6h6a.75.75 0 010 1.5h-6v6a.75.75 0 01-1.5 0v-6h-6a.75.75 0 010-1.5h6v-6A.75.75 0 0112 4.5z" clip-rule="evenodd" />
        </svg>
        New Account
    </button>
</div>
<div class="overflow-x-auto bg-base-100 rounded-box shadow">
    <table class="table table-zebra">
        <thead>
            <tr class="text-sm uppercase text-base-content/70">
                <th class="w-1/3">Account</th>
                <th>Type</th>
                <th class="text-right">Balance</th>
                <th>Due Date</th>
                <th class="text-right">Actions</th>
            </tr>
        </thead>
        <tbody id="account-rows"
               hx-get="{% url 'finance:account-list' %}"
               hx-trigger="load, accountsChanged from:body"
               hx-target="this"
               hx-swap="innerHTML">
            {% include "finance/partials/account_rows.html" %}
        </tbody>
    </table>
</div>
<dialog id="account-modal" class="modal">
    <div class="modal-box w-11/12 max-w-2xl" id="modal-body"></div>
    <form method="dialog" class="modal-backdrop">
        <button>Close</button>
    </form>
</dialog>
<script>
    const accountModal = document.getElementById('account-modal');

    function toggleAccountFormField(wrapper, shouldShow, required) {
        if (!wrapper) {
            return;
        }
        wrapper.style.display = shouldShow ? '' : 'none';
        const input = wrapper.querySelector('[name="' + wrapper.dataset.fieldName + '"]');
        if (!input) {
            return;
        }
        if (shouldShow) {
            input.removeAttribute('disabled');
            if (required) {
                input.setAttribute('required', 'required');
            } else {
                input.removeAttribute('required');
            }
        } else {
            input.setAttribute('disabled', 'disabled');
            input.removeAttribute('required');
            if (input.type !== 'hidden' && input.type !== 'file') {
                input.value = '';
            }
        }
    }

    function initializeAccountFormModal() {
        const modalBody = document.getElementById('modal-body');
        const form = modalBody.querySelector('form[data-account-form="true"]');
        if (!form || form.dataset.enhanced === 'true') {
            return;
        }

        const routingWrapper = form.querySelector('[data-field-name="routing_number"]');
        const interestWrapper = form.querySelector('[data-field-name="interest_rate"]');
        const dueDateWrapper = form.querySelector('[data-field-name="due_date"]');
        const accountTypeSelect = form.querySelector('#id_account_type');

        if (!accountTypeSelect) {
            return;
        }

        const routingTypes = new Set(['checking', 'savings']);
        const interestTypes = new Set(['savings', 'credit_card', 'loan']);
        const dueDateTypes = new Set(['credit_card', 'loan']);

        function applyRules() {
            const value = accountTypeSelect.value;
            toggleAccountFormField(routingWrapper, routingTypes.has(value), routingTypes.has(value));
            toggleAccountFormField(interestWrapper, interestTypes.has(value), interestTypes.has(value));
            toggleAccountFormField(dueDateWrapper, dueDateTypes.has(value), dueDateTypes.has(value));
        }

        accountTypeSelect.addEventListener('change', applyRules);
        applyRules();
        form.dataset.enhanced = 'true';
    }

    document.addEventListener('htmx:afterSwap', function (event) {
        if (event.target.id === 'modal-body') {
            accountModal.showModal();
            initializeAccountFormModal();
        }
    });

    document.addEventListener('closeAccountModal', function () {
        if (accountModal.open) {
            accountModal.close();
        }
        document.getElementById('modal-body').innerHTML = '';
    });

    accountModal.addEventListener('close', function () {
        document.getElementById('modal-body').innerHTML = '';
    });
</script>
{% endblock %}
