{% extends "base.html" %}
{% load humanize %}
{% block title %}{{ account.name }} · Accounts · Household{% endblock %}
{% block content %}
<div class="flex items-center gap-3 mb-6">
    <a href="{% url 'finance:account-list' %}" class="btn btn-ghost btn-sm">← Back to Accounts</a>
    <h1 class="text-2xl font-semibold">{{ account.name }}</h1>
</div>
<div class="grid gap-6">
    <div class="card bg-base-100 shadow">
        <div class="card-body">
            <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
                <div>
                    <div class="text-sm uppercase text-base-content/60">Account Number</div>
                    <div class="text-lg font-mono">{{ account.account_number }}</div>
                    <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <div class="text-sm text-base-content/60">Type</div>
                            <div class="text-lg capitalize">{{ account.get_account_type_display }}</div>
                        </div>
                        {% if show_routing %}
                        <div>
                            <div class="text-sm text-base-content/60">Routing Number</div>
                            <div class="text-lg font-mono">{{ account.routing_number|default:"—" }}</div>
                        </div>
                        {% endif %}
                        {% if show_interest %}
                        <div>
                            <div class="text-sm text-base-content/60">Interest Rate</div>
                            <div class="text-lg">
                                {% if account.interest_rate %}
                                    {{ account.interest_rate }}%
                                {% else %}
                                    <span class="text-base-content/50">—</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        {% if show_due_date %}
                        <div>
                            <div class="text-sm text-base-content/60">Due Date</div>
                            <div class="text-lg">
                                {% if account.due_date %}
                                    {{ account.due_date|date:"M j, Y" }}
                                {% else %}
                                    <span class="text-base-content/50">—</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-sm uppercase text-base-content/60">Balance</div>
                    <div class="text-4xl font-mono">${{ account.balance|floatformat:2|intcomma }}</div>
                    <div class="mt-4 flex flex-wrap gap-2 justify-end">
                        <button class="btn btn-outline"
                                hx-get="{% url 'finance:account-update' account.pk %}"
                                hx-target="#modal-body"
                                hx-swap="innerHTML">
                            Edit Account
                        </button>
                        <button class="btn btn-outline btn-error"
                                hx-get="{% url 'finance:account-delete' account.pk %}"
                                hx-target="#modal-body"
                                hx-swap="innerHTML">
                            Delete Account
                        </button>
                        <button class="btn btn-primary"
                                hx-get="{% url 'finance:transaction-create' %}?account={{ account.pk }}"
                                hx-target="#modal-body"
                                hx-swap="innerHTML">
                            Add Transaction
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="space-y-4">
        <div class="flex items-center justify-between">
            <h2 class="text-xl font-semibold">Transactions</h2>
            <span class="text-sm text-base-content/60">Current month by default</span>
        </div>
           <div id="account-transactions"
               hx-get="{{ transactions_url }}"
               hx-trigger="load, transactionsChanged[event.detail && event.detail.accounts && event.detail.accounts.includes({{ account.pk }})] from:body"
               hx-target="this"
               hx-swap="outerHTML"></div>
    </div>
</div>
<dialog id="account-modal" class="modal">
    <div class="modal-box w-11/12 max-w-2xl" id="modal-body"></div>
    <form method="dialog" class="modal-backdrop">
        <button>Close</button>
    </form>
</dialog>
<script>
    const accountModal = document.getElementById('account-modal');

    function toggleAccountFormField(wrapper, shouldShow, required) {
        if (!wrapper) {
            return;
        }
        wrapper.style.display = shouldShow ? '' : 'none';
        const input = wrapper.querySelector('[name="' + wrapper.dataset.fieldName + '"]');
        if (!input) {
            return;
        }
        if (shouldShow) {
            input.removeAttribute('disabled');
            if (required) {
                input.setAttribute('required', 'required');
            } else {
                input.removeAttribute('required');
            }
        } else {
            input.setAttribute('disabled', 'disabled');
            input.removeAttribute('required');
            if (input.type !== 'hidden' && input.type !== 'file') {
                input.value = '';
            }
        }
    }

    function initializeAccountFormModal() {
        const modalBody = document.getElementById('modal-body');
        const form = modalBody.querySelector('form[data-account-form="true"]');
        if (!form || form.dataset.enhanced === 'true') {
            return;
        }

        const routingWrapper = form.querySelector('[data-field-name="routing_number"]');
        const interestWrapper = form.querySelector('[data-field-name="interest_rate"]');
        const dueDateWrapper = form.querySelector('[data-field-name="due_date"]');
        const accountTypeSelect = form.querySelector('#id_account_type');

        if (!accountTypeSelect) {
            return;
        }

        const routingTypes = new Set(['checking', 'savings']);
        const interestTypes = new Set(['savings', 'credit_card', 'loan']);
        const dueDateTypes = new Set(['credit_card', 'loan']);

        function applyRules() {
            const value = accountTypeSelect.value;
            toggleAccountFormField(routingWrapper, routingTypes.has(value), routingTypes.has(value));
            toggleAccountFormField(interestWrapper, interestTypes.has(value), interestTypes.has(value));
            toggleAccountFormField(dueDateWrapper, dueDateTypes.has(value), dueDateTypes.has(value));
        }

        accountTypeSelect.addEventListener('change', applyRules);
        applyRules();
        form.dataset.enhanced = 'true';
    }

    document.addEventListener('htmx:afterSwap', function (event) {
        if (event.target.id === 'modal-body') {
            accountModal.showModal();
            initializeAccountFormModal();
        }
    });

    document.addEventListener('closeAccountModal', function () {
        if (accountModal.open) {
            accountModal.close();
        }
        document.getElementById('modal-body').innerHTML = '';
    });

    accountModal.addEventListener('close', function () {
        document.getElementById('modal-body').innerHTML = '';
    });
</script>
{% endblock %}
